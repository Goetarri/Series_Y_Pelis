<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watchlist</title>
<style>
:root {
  --color-primario: #0077ff;
  --color-borrar: #ff4444;
  --fondo: #f5f5f5;
  --texto: #222;
  --barra-bg: #eee;
  --barra-activo: #0077ff;
  --barra-texto: #fff;
  --barra-inactivo: #aaa;
  --btn-agregar-color: #112072;
}

body {
  font-family: system-ui, sans-serif;
  background: var(--fondo);
  margin: 0;
  padding: 1rem 0 4rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 95%;
  max-width: 600px;
  margin-bottom: 0.5rem;
  background: var(--color-primario);
  border-radius: 0px;
  padding: 0.4rem 0.6rem;
  position: sticky;
  top: 0;
  z-index: 3000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

h1 {
  font-size: 1.6rem;
  color: var(--texto);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex:1;
  justify-content: center;
}

/* Ensure header title is readable on blue background */
.header h1 { color: #fff; }

.menu-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
}

.menu {
  display: none;
  position: absolute;
  top: 2.5rem;
  left: 1rem;
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  border-radius: 8px;
  overflow: hidden;
  z-index: 1000;
}
.menu.visible { display: block; }
.menu button {
  display: block;
  width: 100%;
  padding: 0.6rem 1rem;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 1rem;
}
.menu button:hover { background: #f0f0f0; }

#btnAgregarForm {
  background: var(--fondo);
  color: var(--btn-agregar-color);
  font-weight: bold;
  font-size: 2.0rem;
  border: 2px solid var(--btn-agregar-color);
  border-radius: 8px;
  cursor: pointer;
  padding: 0.2rem 0.6rem;
}

.form {
  background: #fff;
  padding: 1rem;
  border-radius: 12px;
  width: 95%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  pointer-events: none;
  visibility: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease, margin-bottom 0.4s ease;
}
.form.visible {
  max-height: 500px;
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
  margin-bottom: 2rem;
}
.form input, .form select, .form button {
  font-size:1rem; padding:0.6rem; border-radius:8px; border:1px solid #ccc;
  width:100%; box-sizing:border-box;
}
.form button {
  background: var(--color-primario); color:#fff; border:none; cursor:pointer;
}
.form button:hover { background:#005fcb; }

.filtro-container {
  display: flex;
  align-items: center;
  width: 95%;
  max-width: 600px;
  margin: 0.5rem auto 0.5rem auto;
  gap: 0.5rem;
}

.filtro-label {
  font-weight: bold;
  white-space: nowrap;
}

.filtro-select {
  flex: 1;
  padding: 0.6rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
}

table {
  width:95%; max-width:600px; border-collapse: separate; margin-bottom:1rem; background:white; table-layout:fixed;
  border-radius: 10px;
  overflow: hidden;
}
thead { background: var(--color-primario); color:white; }
thhead th:first-child { border-top-left-radius: 10px; }
thhead th:last-child { border-top-right-radius: 10px; }
#tablaSeries thead { background: #1a8f62; }
#tablaPeliculas thead { background: #8b6f47; }
th, td { padding:0.4rem 0.75rem; text-align:left; word-wrap:break-word; }
th[data-sortable] { cursor: pointer; user-select: none; }
th[data-sortable]:hover { background-color: rgba(0,0,0,0.1); }
.sort-indicator { margin-left: 0.3rem; }
tbody tr:nth-child(odd) { background:#f9f9f9; cursor:pointer; }

.delete-btn, .edit-btn {
  background:none; border:none; cursor:pointer; padding:0.1rem 0.25rem;
  font-size:0.9rem; display:inline; margin:0 0.15rem;
}
.edit-btn { color:#0077ff; }
.delete-btn { color:var(--color-borrar); }
.delete-btn:hover, .edit-btn:hover { opacity:0.7; }

.barra {
  position:fixed; bottom:0; left:0; width:100%;
  display:flex; background: var(--barra-bg);
  height:3.5rem; box-shadow:0 -2px 6px rgba(0,0,0,0.1);
}
.barra button {
  margin:0; border-radius:0; background: var(--barra-inactivo);
  color:#fff; border:none; cursor:pointer; height:100%;
  font-size:1.2rem; font-weight:bold;
}
.barra button.activo {
  background: var(--barra-activo); color: var(--barra-texto);
}
#btnSeries { flex:0 0 50%; }
#btnPeliculas { flex:0 0 50%; }

#modalSinopsis {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.7); align-items:center; justify-content:center;
  z-index:2000;
}
#modalSinopsis .contenido {
  background:#fff; border-radius:16px; max-width:90%; width:400px;
  max-height:80%; overflow:auto; padding:0; box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#modalSinopsis .texto { padding:1rem; text-align:center; }
#cerrarModal {
  background: var(--color-primario); color:#fff; border:none;
  padding:0.5rem 1.2rem; border-radius:8px; cursor:pointer;
  margin: 0.8rem auto 1rem auto; display:block; font-weight:bold;
}
</style>
</head>
<body>

<div class="header">
  <button class="menu-btn" id="btnMenu">‚ò∞</button>
  <h1 id="tituloPrincipal">
    <span id="iconoTitulo">üì∫</span><span id="textoTitulo"> Series</span>
  </h1>
  <button id="btnAgregarForm">+</button>

  <div class="menu" id="menuOpciones">
    <button id="btnExportar">Exportar CSV</button>
    <button id="btnImportar">Importar CSV</button>
    <input type="file" id="inputImportar" accept=".csv" style="display:none">
  </div>
</div>

<div class="form" id="formulario">
  <select id="tipo">
    <option value="series" selected>Serie</option>
    <option value="peliculas">Pel√≠cula</option>
  </select>
  <select id="plataforma">
    <option value="Netflix">Netflix</option>
    <option value="Prime Video">Prime Video</option>
    <option value="HBO Max">HBO Max</option>
    <option value="Disney+">Disney+</option>
    <option value="AppleTV+">AppleTV+</option>
    <option value="Movistar+">Movistar+</option>
    <option value="Filmin">Filmin</option>
  </select>
  <input type="text" id="titulo" placeholder="T√≠tulo">
  <button id="agregar">Agregar</button>
</div>

<div class="filtro-container">
  <label for="filtroPlataforma" class="filtro-label">Filtrar:</label>
  <select id="filtroPlataforma" class="filtro-select">
    <option value="todas">Todas las plataformas</option>
  </select>
</div>

<table id="tablaSeries">
  <colgroup>
    <col style="width:50%">
    <col style="width:30%">
    <col style="width:20%">
  </colgroup>
  <thead><tr><th data-sortable="titulo">T√≠tulo <span class="sort-indicator"></span></th><th data-sortable="plataforma">Plataforma <span class="sort-indicator"></span></th><th style="text-align:center"></th></tr></thead>
  <tbody id="cuerpoSeries"></tbody>
</table>

<table id="tablaPeliculas" style="display:none">
  <colgroup>
    <col style="width:50%">
    <col style="width:30%">
    <col style="width:20%">
  </colgroup>
  <thead><tr><th data-sortable="titulo">T√≠tulo <span class="sort-indicator"></span></th><th data-sortable="plataforma">Plataforma <span class="sort-indicator"></span></th><th style="text-align:center"></th></tr></thead>
  <tbody id="cuerpoPeliculas"></tbody>
</table>

<div class="barra">
  <button id="btnSeries" class="activo">Series</button>
  <button id="btnPeliculas">Pelis</button>
</div>

<div id="modalSinopsis">
  <div class="contenido">
    <div class="texto" id="textoSinopsis"></div>
    <button id="cerrarModal">Cerrar</button>
  </div>
</div>

<script>
const tipoSelect = document.getElementById('tipo');
const tituloInput = document.getElementById('titulo');
const plataformaSelect = document.getElementById('plataforma');
const agregarBtn = document.getElementById('agregar');
const formulario = document.getElementById('formulario');
const iconoTitulo = document.getElementById('iconoTitulo');
const textoTitulo = document.getElementById('textoTitulo');
const tablaSeries = document.getElementById('tablaSeries');
const tablaPeliculas = document.getElementById('tablaPeliculas');
const cuerpoSeries = document.getElementById('cuerpoSeries');
const cuerpoPeliculas = document.getElementById('cuerpoPeliculas');
const btnSeries = document.getElementById('btnSeries');
const btnPeliculas = document.getElementById('btnPeliculas');
const btnAgregarForm = document.getElementById('btnAgregarForm');
const filtroPlataforma = document.getElementById('filtroPlataforma');

let series = JSON.parse(localStorage.getItem('series')) || [];
let peliculas = JSON.parse(localStorage.getItem('peliculas')) || [];

// Sorting state
let sortState = { field: 'titulo', asc: true, type: 'series' };

// Inicializar desplegable Tipo
tipoSelect.value = 'series';

function guardar() {
  localStorage.setItem('series', JSON.stringify(series));
  localStorage.setItem('peliculas', JSON.stringify(peliculas));
}

function actualizarFiltro(lista) {
  const plataformas = Array.from(new Set(lista.map(i => i.plataforma))).sort();
  filtroPlataforma.innerHTML = '<option value="todas">Todas las plataformas</option>';
  plataformas.forEach(p => { filtroPlataforma.innerHTML += `<option value="${p}">${p}</option>`; });
}

function sortData(lista, field, asc) {
  return [...lista].sort((a, b) => {
    const aVal = a[field].toLowerCase();
    const bVal = b[field].toLowerCase();
    return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
  });
}

function updateSortIndicators(tabla, field, asc) {
  tabla.querySelectorAll('th[data-sortable]').forEach(th => {
    const indicator = th.querySelector('.sort-indicator');
    if(th.dataset.sortable === field) {
      indicator.textContent = asc ? '‚ñ≤' : '‚ñº';
    } else {
      indicator.textContent = '';
    }
  });
}

function render(lista, cuerpo, tipo, tabla) {
  const filtro = filtroPlataforma.value;
  const sortedLista = sortData(lista, sortState.field, sortState.asc);
  updateSortIndicators(tabla, sortState.field, sortState.asc);
  cuerpo.innerHTML = '';
  sortedLista.filter(item => filtro==='todas'||item.plataforma===filtro)
       .forEach((item)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.titulo}</td><td>${item.plataforma}</td><td><button class="edit-btn">‚úèÔ∏è</button><button class="delete-btn">üóëÔ∏è</button></td>`;
    
    tr.querySelector('.edit-btn').addEventListener('click', e=>{
      e.stopPropagation();
      const actualIndex = lista.findIndex(i => i.titulo === item.titulo && i.plataforma === item.plataforma);
      tipoSelect.value = tipo;
      tituloInput.value = item.titulo;
      plataformaSelect.value = item.plataforma;
      formulario.classList.add('visible');
      tituloInput.focus();
      agregarBtn.textContent = 'Guardar Cambios';
      agregarBtn.dataset.editIndex = actualIndex;
      agregarBtn.dataset.editType = tipo;
    });
    
    tr.querySelector('.delete-btn').addEventListener('click', e=>{
      e.stopPropagation();
      const actualIndex = lista.findIndex(i => i.titulo === item.titulo && i.plataforma === item.plataforma);
      lista.splice(actualIndex,1); guardar(); aplicarFiltro();
    });

    tr.addEventListener('click', () => {
      const API_KEY = 'a0080a31ac38a365707cbe63be481cb0'; // Reemplazar con tu TMDb API key
      const endpoint = tipo==='series' ? 'tv' : 'movie';
      fetch(`https://api.themoviedb.org/3/search/${endpoint}?api_key=${API_KEY}&query=${encodeURIComponent(item.titulo)}`)
        .then(res => res.json())
        .then(data => {
          if(data.results && data.results.length > 0){
            const result = data.results[0];
            const poster = result.poster_path ? `<img src="https://image.tmdb.org/t/p/w300${result.poster_path}" style="max-width:100%; border-radius:8px; margin-bottom:1rem;">` : '';

            if(tipo==='series'){
              // Obtener n√∫mero de temporadas con fetch adicional
              fetch(`https://api.themoviedb.org/3/tv/${result.id}?api_key=${API_KEY}`)
                .then(res2 => res2.json())
                .then(detalle => {
                  let infoExtra = '';
                  if(result.first_air_date) infoExtra = ` (${result.first_air_date.slice(0,4)})`;
                  if(detalle.number_of_seasons) infoExtra += ` - ${detalle.number_of_seasons} temporada${detalle.number_of_seasons>1?'s':''}`;
                  document.getElementById('textoSinopsis').innerHTML = `
                    ${poster}
                    <h3>${result.name}${infoExtra}</h3>
                    <p>${result.overview || 'Sin sinopsis disponible.'}</p>
                  `;
                });
            } else {
              let infoExtra = '';
              if(result.release_date) infoExtra = ` (${result.release_date.slice(0,4)})`;
              document.getElementById('textoSinopsis').innerHTML = `
                ${poster}
                <h3>${result.title}${infoExtra}</h3>
                <p>${result.overview || 'Sin sinopsis disponible.'}</p>
              `;
            }

          } else {
            document.getElementById('textoSinopsis').innerHTML = `<p>No se encontr√≥ sinopsis.</p>`;
          }
          document.getElementById('modalSinopsis').style.display = 'flex';
        })
        .catch(()=> {
          document.getElementById('textoSinopsis').innerHTML = `<p>Error al consultar la API.</p>`;
          document.getElementById('modalSinopsis').style.display = 'flex';
        });
    });

    cuerpo.appendChild(tr);
  });
}

function aplicarFiltro() {
  if(tablaSeries.style.display==='table') render(series,cuerpoSeries,'series', tablaSeries);
  else render(peliculas,cuerpoPeliculas,'peliculas', tablaPeliculas);
}

function mostrarLista(tipo) {
  if(tipo==='series'){
    tablaSeries.style.display='table'; tablaPeliculas.style.display='none';
    btnSeries.classList.add('activo'); btnPeliculas.classList.remove('activo');
    iconoTitulo.textContent='üì∫'; textoTitulo.textContent=' Series';
    actualizarFiltro(series);
    sortState.type = 'series';
    render(series,cuerpoSeries,'series', tablaSeries);
  } else {
    tablaSeries.style.display='none'; tablaPeliculas.style.display='table';
    btnPeliculas.classList.add('activo'); btnSeries.classList.remove('activo');
    iconoTitulo.textContent='üéûÔ∏è'; textoTitulo.textContent=' Pel√≠culas';
    actualizarFiltro(peliculas);
    sortState.type = 'peliculas';
    render(peliculas,cuerpoPeliculas,'peliculas', tablaPeliculas);
  }
}
function agregarElemento(){
  const titulo = tituloInput.value.trim();
  const plataforma = plataformaSelect.value;
  const tipo = tipoSelect.value;
  if(!titulo) return;
  
  // Si estamos editando
  if(agregarBtn.dataset.editIndex !== undefined){
    const editIndex = parseInt(agregarBtn.dataset.editIndex);
    const editType = agregarBtn.dataset.editType;
    const lista = editType==='series'?series:peliculas;
    lista[editIndex] = {titulo, plataforma};
    delete agregarBtn.dataset.editIndex;
    delete agregarBtn.dataset.editType;
    agregarBtn.textContent = 'Agregar';
  } else {
    // Si estamos agregando
    const lista = tipo==='series'?series:peliculas;
    if(!lista.some(e=>e.titulo.toLowerCase()===titulo.toLowerCase())){
      lista.push({titulo,plataforma});
    }
  }
  guardar(); mostrarLista(tipo);
  tituloInput.value=''; formulario.classList.remove('visible');
}

agregarBtn.addEventListener('click', agregarElemento);
tituloInput.addEventListener('keydown', e=>{ if(e.key==='Enter') agregarElemento(); });
btnSeries.addEventListener('click', ()=>{ mostrarLista('series'); formulario.classList.remove('visible'); });
btnPeliculas.addEventListener('click', ()=>{ mostrarLista('peliculas'); formulario.classList.remove('visible'); });

// Bot√≥n "+" ajustando Tipo seg√∫n lista activa
btnAgregarForm.addEventListener('click', ()=>{
  formulario.classList.toggle('visible');
  tipoSelect.value = tablaSeries.style.display==='table' ? 'series' : 'peliculas';
  tituloInput.focus();
});

filtroPlataforma.addEventListener('change', aplicarFiltro);

document.getElementById('cerrarModal').addEventListener('click', ()=> {
  document.getElementById('modalSinopsis').style.display='none';
});

// Cerrar modal de sinopsis al hacer clic en el overlay (fuera del contenido)
const modalSinopsis = document.getElementById('modalSinopsis');
if (modalSinopsis) {
  modalSinopsis.addEventListener('click', (e) => {
    if (e.target === modalSinopsis) {
      modalSinopsis.style.display = 'none';
    }
  });
}

// --- Men√∫ CSV ---
const btnMenu = document.getElementById('btnMenu');
const menuOpciones = document.getElementById('menuOpciones');
const btnExportar = document.getElementById('btnExportar');
const btnImportar = document.getElementById('btnImportar');
const inputImportar = document.getElementById('inputImportar');

btnMenu.addEventListener('click', () => menuOpciones.classList.toggle('visible'));

// Cerrar el men√∫ si el usuario hace clic fuera de √©l
document.addEventListener('click', (e) => {
  const target = e.target;
  if (!menuOpciones.contains(target) && !btnMenu.contains(target)) {
    menuOpciones.classList.remove('visible');
  }
});

// Exportar ambas listas
btnExportar.addEventListener('click', () => {
  let csv = 'Titulo,Plataforma,Tipo\n';
  series.forEach(e => { csv += `${e.titulo},${e.plataforma},Serie\n`; });
  peliculas.forEach(e => { csv += `${e.titulo},${e.plataforma},Pel√≠cula\n`; });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'watchlist.csv';
  a.click();
  URL.revokeObjectURL(url);
  menuOpciones.classList.remove('visible');
});

// Importar CSV
btnImportar.addEventListener('click', () => inputImportar.click());
inputImportar.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const lines = ev.target.result.split('\n').slice(1);
    lines.forEach(line => {
      const [titulo, plataforma, tipo] = line.split(',');
      if(!titulo || !plataforma || !tipo) return;
      const lista = tipo.trim().toLowerCase() === 'serie' ? series : peliculas;
      if(!lista.some(e => e.titulo.toLowerCase() === titulo.trim().toLowerCase())){
        lista.push({ titulo: titulo.trim(), plataforma: plataforma.trim() });
      }
    });
    guardar();
    filtroPlataforma.value = 'todas';
    sortState = { field: 'titulo', asc: true, type: 'series' };
    mostrarLista('series');
    inputImportar.value = '';
    menuOpciones.classList.remove('visible');
  };
  reader.readAsText(file);
});

mostrarLista('series');

// Add header click listeners for sorting
tablaSeries.querySelectorAll('th[data-sortable]').forEach(th => {
  th.addEventListener('click', () => {
    const field = th.dataset.sortable;
    sortState.asc = sortState.field === field ? !sortState.asc : true;
    sortState.field = field;
    render(series, cuerpoSeries, 'series', tablaSeries);
  });
});

tablaPeliculas.querySelectorAll('th[data-sortable]').forEach(th => {
  th.addEventListener('click', () => {
    const field = th.dataset.sortable;
    sortState.asc = sortState.field === field ? !sortState.asc : true;
    sortState.field = field;
    render(peliculas, cuerpoPeliculas, 'peliculas', tablaPeliculas);
  });
});
</script>
</body>
</

